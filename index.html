<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Rates Monitor - Clone Coinglass</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0b0f19;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
        }

        .header {
            background: #141920;
            border-bottom: 1px solid #1e2329;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #f0b90b;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-header {
            background: #1e2329;
            border: 1px solid #2b3139;
            color: #eaecef;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-header:hover {
            background: #2b3139;
            border-color: #f0b90b;
        }

        .btn-header.active {
            background: #f0b90b;
            color: #000;
            border-color: #f0b90b;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #76808f;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #0ecb81;
            animation: pulse 2s infinite;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 20px;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .page-title h1 {
            font-size: 24px;
            font-weight: 600;
            color: #eaecef;
        }

        .page-subtitle {
            color: #76808f;
            font-size: 13px;
            line-height: 1.5;
        }

        .controls-bar {
            background: #141920;
            border: 1px solid #1e2329;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .controls-grid {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-label {
            font-size: 12px;
            color: #76808f;
            font-weight: 500;
        }

        .toggle-group {
            display: flex;
            background: #1e2329;
            border-radius: 4px;
            border: 1px solid #2b3139;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #76808f;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: #f0b90b;
            color: #000;
        }

        .search-box {
            background: #1e2329;
            border: 1px solid #2b3139;
            border-radius: 4px;
            padding: 6px 10px;
            color: #eaecef;
            font-size: 12px;
            width: 200px;
        }

        .search-box::placeholder {
            color: #76808f;
        }

        .add-crypto-btn {
            background: #0ecb81;
            border: none;
            color: #000;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .main-table {
            background: #141920;
            border: 1px solid #1e2329;
            border-radius: 6px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #1e2329;
            background: #1a1f2a;
        }

        .table-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #eaecef;
        }

        .table-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .funding-table {
            width: 100%;
            border-collapse: collapse;
            background: #141920;
        }

        .funding-table th {
            background: #1a1f2a;
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            font-size: 12px;
            color: #76808f;
            border-bottom: 1px solid #1e2329;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        .funding-table th:hover {
            background: #1e2329;
        }

        .funding-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #1e2329;
            font-size: 13px;
            vertical-align: middle;
        }

        .funding-table tr:hover {
            background: #1a1f2a;
        }

        .ranking-cell {
            color: #76808f;
            font-weight: 500;
            width: 60px;
        }

        .symbol-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }

        .crypto-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0b90b, #fcd535);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #000;
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
        }

        .symbol-name {
            font-weight: 600;
            color: #eaecef;
            font-size: 14px;
        }

        .portfolio-cell {
            min-width: 200px;
        }

        .position-long {
            color: #0ecb81;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .position-short {
            color: #f6465d;
            font-size: 12px;
        }

        .exchange-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 6px;
        }

        .badge-binance {
            background: rgba(240, 185, 11, 0.1);
            color: #f0b90b;
            border: 1px solid rgba(240, 185, 11, 0.2);
        }

        .badge-bybit {
            background: rgba(14, 203, 129, 0.1);
            color: #0ecb81;
            border: 1px solid rgba(14, 203, 129, 0.2);
        }

        .badge-okx {
            background: rgba(13, 132, 242, 0.1);
            color: #0d84f2;
            border: 1px solid rgba(13, 132, 242, 0.2);
        }

        .apr-positive {
            color: #0ecb81;
            font-weight: 600;
        }

        .apr-negative {
            color: #f6465d;
            font-weight: 600;
        }

        .rate-positive {
            color: #0ecb81;
            font-weight: 500;
        }

        .rate-negative {
            color: #f6465d;
            font-weight: 500;
        }

        .spread-positive {
            color: #0ecb81;
        }

        .spread-negative {
            color: #f6465d;
        }

        .open-interest {
            color: #eaecef;
            font-weight: 500;
        }

        .settlement-time {
            color: #76808f;
            font-size: 12px;
        }

        .trade-buttons {
            display: flex;
            gap: 4px;
        }

        .trade-btn {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
        }

        .trade-btn.binance {
            background: rgba(240, 185, 11, 0.1);
            color: #f0b90b;
            border: 1px solid rgba(240, 185, 11, 0.3);
        }

        .trade-btn.bybit {
            background: rgba(14, 203, 129, 0.1);
            color: #0ecb81;
            border: 1px solid rgba(14, 203, 129, 0.3);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(11, 15, 25, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(240, 185, 11, 0.1);
            border-left: 2px solid #f0b90b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #76808f;
        }

        .sort-indicator {
            margin-left: 4px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .controls-grid {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .funding-table {
                font-size: 12px;
            }
            
            .funding-table th,
            .funding-table td {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                Funding Rates Monitor
            </div>
            <div class="header-controls">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connection-status">Connecting...</span>
                </div>
                <button class="btn-header" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn-header" onclick="exportData()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <h1>ðŸŽ¯ Funding Rate Arbitrage</h1>
            </div>
            <div class="page-subtitle">
                Real-time funding rates comparison across multiple exchanges for cryptocurrency perpetual contracts
            </div>
        </div>

        <div class="controls-bar">
            <div class="controls-grid">
                <div class="control-group">
                    <span class="control-label">Contract Type:</span>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-type="usdt">USDT Margined</button>
                        <button class="toggle-btn" data-type="coin">Coin Margined</button>
                    </div>
                </div>

                <div class="control-group">
                    <span class="control-label">Time Frame:</span>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-time="current">Current</button>
                        <button class="toggle-btn" data-time="1d">1 Day</button>
                        <button class="toggle-btn" data-time="7d">7 Day</button>
                        <button class="toggle-btn" data-time="30d">30 Day</button>
                    </div>
                </div>

                <div class="control-group">
                    <input type="text" class="search-box" id="search-input" placeholder="Search cryptocurrency..." onkeyup="filterTable()">
                </div>

                <div class="control-group">
                    <button class="add-crypto-btn" onclick="showAddCryptoModal()">
                        <i class="fas fa-plus"></i>
                        Add Crypto
                    </button>
                </div>
            </div>
        </div>

        <div class="main-table" style="position: relative;">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-list"></i>
                    Exchanges
                    <span id="data-count" style="color: #76808f; font-size: 12px;">(0)</span>
                </div>
                <div class="table-controls">
                    <button class="btn-header" onclick="toggleAutoRefresh()">
                        <i class="fas fa-clock"></i>
                        <span id="auto-refresh-status">Auto (Off)</span>
                    </button>
                </div>
            </div>

            <table class="funding-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('ranking')" style="width: 60px;">
                            Ranking
                            <span class="sort-indicator" id="sort-ranking"></span>
                        </th>
                        <th onclick="sortTable('symbol')" style="width: 140px;">
                            Symbol
                            <span class="sort-indicator" id="sort-symbol"></span>
                        </th>
                        <th onclick="sortTable('portfolio')" style="width: 220px;">
                            Portfolio
                            <span class="sort-indicator" id="sort-portfolio"></span>
                        </th>
                        <th onclick="sortTable('apr')" style="width: 100px; text-align: right;">
                            APR
                            <span class="sort-indicator" id="sort-apr"></span>
                        </th>
                        <th onclick="sortTable('fundingRate')" style="width: 120px; text-align: right;">
                            Net Funding Rate
                            <span class="sort-indicator" id="sort-fundingRate"></span>
                        </th>
                        <th onclick="sortTable('spread')" style="width: 100px; text-align: right;">
                            Spread Rate
                            <span class="sort-indicator" id="sort-spread"></span>
                        </th>
                        <th onclick="sortTable('openInterest')" style="width: 120px; text-align: right;">
                            Open Interest
                            <span class="sort-indicator" id="sort-openInterest"></span>
                        </th>
                        <th style="width: 100px;">
                            Settlement
                        </th>
                        <th style="width: 80px; text-align: center;">
                            Trade
                        </th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-chart-line"></i><br>
                            Loading funding rates data...
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="loading-overlay" id="loading-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        var BACKEND_URL = 'https://funding-rates-backend.onrender.com';
        var currentData = [];
        var filteredData = [];
        var isLoading = false;
        var autoRefreshInterval = null;
        var sortConfig = { column: null, direction: 'asc' };

        function updateConnectionStatus(message, isOnline) {
            var statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            
            var dot = document.querySelector('.status-dot');
            dot.style.background = isOnline ? '#0ecb81' : '#f6465d';
            
            console.log('Status:', message);
        }

        function setLoading(loading) {
            isLoading = loading;
            var overlay = document.getElementById('loading-overlay');
            overlay.style.display = loading ? 'flex' : 'none';
        }

        function formatNumber(num, decimals = 2) {
            if (num >= 1000000) {
                return '$' + (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return '$' + (num / 1000).toFixed(1) + 'K';
            } else {
                return '$' + num.toFixed(decimals);
            }
        }

        function calculateAPR(fundingRate) {
            return (fundingRate * 3 * 365 * 100).toFixed(2);
        }

        function getNextSettlement() {
            var now = new Date();
            var minutes = now.getMinutes();
            var nextHour = new Date(now);
            
            if (minutes < 0) nextHour.setHours(now.getHours(), 0, 0, 0);
            else if (minutes < 8) nextHour.setHours(now.getHours(), 8, 0, 0);
            else if (minutes < 16) nextHour.setHours(now.getHours(), 16, 0, 0);
            else nextHour.setHours(now.getHours() + 1, 0, 0, 0);
            
            var diff = nextHour - now;
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0') + ':' + 
                   Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
        }

        function refreshData() {
            if (isLoading) return;
            
            setLoading(true);
            updateConnectionStatus('Loading...', false);
            
            fetch(BACKEND_URL + '/api/funding-rates', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            })
            .then(function(result) {
                console.log('Data received:', result);
                
                var fundingData = [];
                if (result.success && result.data) {
                    fundingData = result.data;
                } else if (Array.isArray(result)) {
                    fundingData = result;
                }
                
                if (fundingData.length > 0) {
                    currentData = processDataForCoinglass(fundingData);
                    filteredData = currentData.slice();
                    renderTable(filteredData);
                    
                    updateConnectionStatus('Live (' + fundingData.length + ' rates)', true);
                    document.getElementById('data-count').textContent = '(' + currentData.length + ')';
                    
                    if (!autoRefreshInterval) {
                        startAutoRefresh();
                    }
                } else {
                    throw new Error('No data received');
                }
            })
            .catch(function(error) {
                console.error('Error loading data:', error);
                updateConnectionStatus('Connection failed', false);
                
                if (error.message.includes('Failed to fetch')) {
                    updateConnectionStatus('CORS Error - Check deployment', false);
                }
            })
            .finally(function() {
                setLoading(false);
            });
        }

        function processDataForCoinglass(rawData) {
            var symbolGroups = {};
            
            rawData.forEach(function(item) {
                var symbol = item.symbol;
                if (!symbolGroups[symbol]) {
                    symbolGroups[symbol] = [];
                }
                symbolGroups[symbol].push(item);
            });
            
            var processed = [];
            var ranking = 1;
            
            Object.keys(symbolGroups).forEach(function(symbol) {
                var exchanges = symbolGroups[symbol];
                
                exchanges.sort(function(a, b) {
                    return parseFloat(b.fundingRate) - parseFloat(a.fundingRate);
                });
                
                var longExchange = exchanges[exchanges.length - 1];
                var shortExchange = exchanges[0];
                
                var longRate = parseFloat(longExchange.fundingRate);
                var shortRate = parseFloat(shortExchange.fundingRate);
                var spreadRate = shortRate - longRate;
                var apr = calculateAPR(Math.abs(spreadRate));
                
                var openInterest = exchanges.reduce(function(sum, ex) {
                    return sum + (parseFloat(ex.markPrice) || 0) * 1000;
                }, 0);
                
                processed.push({
                    ranking: ranking++,
                    symbol: symbol,
                    longExchange: longExchange,
                    shortExchange: shortExchange,
                    apr: parseFloat(apr),
                    fundingRate: spreadRate,
                    spreadRate: spreadRate,
                    openInterest: openInterest,
                    exchanges: exchanges,
                    settlement: getNextSettlement()
                });
            });
            
            processed.sort(function(a, b) {
                return b.apr - a.apr;
            });
            
            processed.forEach(function(item, index) {
                item.ranking = index + 1;
            });
            
            return processed;
        }

        function renderTable(data) {
            var tbody = document.getElementById('table-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fas fa-search"></i><br>No data available</td></tr>';
                return;
            }
            
            var rows = data.map(function(item) {
                var aprClass = item.apr > 0 ? 'apr-positive' : item.apr < 0 ? 'apr-negative' : '';
                var rateClass = item.fundingRate > 0 ? 'rate-positive' : item.fundingRate < 0 ? 'rate-negative' : '';
                var spreadClass = item.spreadRate > 0 ? 'spread-positive' : 'spread-negative';
                
                return '<tr>' +
                    '<td class="ranking-cell">' + item.ranking + '</td>' +
                    '<td class="symbol-cell">' +
                        '<div class="crypto-icon">' + item.symbol.substring(0, 2) + '</div>' +
                        '<div class="symbol-info">' +
                            '<div class="symbol-name">' + item.symbol + '</div>' +
                        '</div>' +
                    '</td>' +
                    '<td class="portfolio-cell">' +
                        '<div class="position-long">Long ' + item.symbol + '/USDT <span class="exchange-badge badge-' + item.longExchange.exchange.toLowerCase() + '">' + item.longExchange.exchange + '</span></div>' +
                        '<div class="position-short">Short ' + item.symbol + '/USDT <span class="exchange-badge badge-' + item.shortExchange.exchange.toLowerCase() + '">' + item.shortExchange.exchange + '</span></div>' +
                    '</td>' +
                    '<td style="text-align: right;" class="' + aprClass + '">' + item.apr.toFixed(2) + '%</td>' +
                    '<td style="text-align: right;" class="' + rateClass + '">' + (item.fundingRate * 100).toFixed(4) + '%</td>' +
                    '<td style="text-align: right;" class="' + spreadClass + '">' + (item.spreadRate >= 0 ? '+' : '') + (item.spreadRate * 100).toFixed(2) + '%</td>' +
                    '<td style="text-align: right;" class="open-interest">' + formatNumber(item.openInterest) + '</td>' +
                    '<td class="settlement-time">' + item.settlement + '</td>' +
                    '<td style="text-align: center;">' +
                        '<div class="trade-buttons">' +
                            '<button class="trade-btn ' + item.longExchange.exchange.toLowerCase() + '" title="Trade on ' + item.longExchange.exchange + '">' +
                                '<i class="fas fa-external-link-alt"></i>' +
                            '</button>' +
                            '<button class="trade-btn ' + item.shortExchange.exchange.toLowerCase() + '" title="Trade on ' + item.shortExchange.exchange + '">' +
                                '<i class="fas fa-external-link-alt"></i>' +
                            '</button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
            
            tbody.innerHTML = rows;
        }

        function filterTable() {
            var searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                filteredData = currentData.slice();
            } else {
                filteredData = currentData.filter(function(item) {
                    return item.symbol.toLowerCase().includes(searchTerm) ||
                           item.longExchange.exchange.toLowerCase().includes(searchTerm) ||
                           item.shortExchange.exchange.toLowerCase().includes(searchTerm);
                });
            }
            
            renderTable(filteredData);
        }

        function sortTable(column) {
            if (sortConfig.column === column) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.column = column;
                sortConfig.direction = 'desc';
            }
            
            document.querySelectorAll('.sort-indicator').forEach(function(el) {
                el.textContent = '';
            });
            
            var indicator = document.getElementById('sort-' + column);
            if (indicator) {
                indicator.textContent = sortConfig.direction === 'asc' ? 'â†‘' : 'â†“';
            }
            
            filteredData.sort(function(a, b) {
                var aVal, bVal;
                
                switch(column) {
                    case 'ranking':
                        aVal = a.ranking;
                        bVal = b.ranking;
                        break;
                    case 'symbol':
                        aVal = a.symbol;
                        bVal = b.symbol;
                        break;
                    case 'apr':
                        aVal = a.apr;
                        bVal = b.apr;
                        break;
                    case 'fundingRate':
                        aVal = a.fundingRate;
                        bVal = b.fundingRate;
                        break;
                    case 'spread':
                        aVal = a.spreadRate;
                        bVal = b.spreadRate;
                        break;
                    case 'openInterest':
                        aVal = a.openInterest;
                        bVal = b.openInterest;
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aVal === 'string') {
                    return sortConfig.direction === 'asc' ? 
                        aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });
            
            renderTable(filteredData);
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            
            autoRefreshInterval = setInterval(function() {
                if (!isLoading) {
                    refreshData();
                }
            }, 30000);
            
            document.getElementById('auto-refresh-status').textContent = 'Auto (On)';
            console.log('Auto-refresh started (30s)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            document.getElementById('auto-refresh-status').textContent = 'Auto (Off)';
            console.log('Auto-refresh stopped');
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        }

        function exportData() {
            if (!currentData || currentData.length === 0) {
                alert('No data to export');
                return;
            }
            
            var csvHeaders = 'Ranking,Symbol,Long Exchange,Short Exchange,APR,Net Funding Rate,Spread Rate,Open Interest,Settlement\n';
            var csvRows = currentData.map(function(item) {
                return [
                    item.ranking,
                    item.symbol,
                    item.longExchange.exchange,
                    item.shortExchange.exchange,
                    item.apr.toFixed(2) + '%',
                    (item.fundingRate * 100).toFixed(4) + '%',
                    (item.spreadRate * 100).toFixed(2) + '%',
                    formatNumber(item.openInterest),
                    item.settlement
                ].join(',');
            }).join('\n');
            
            var csvContent = csvHeaders + csvRows;
            var blob = new Blob([csvContent], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = 'funding-rates-arbitrage-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('Data exported to CSV');
        }

        function showAddCryptoModal() {
            var symbol = prompt('Enter cryptocurrency symbol (e.g., BTC, ETH, ADA):');
            if (symbol) {
                symbol = symbol.toUpperCase().trim();
                alert('Add crypto feature: ' + symbol + '\nThis would connect to exchange APIs to add new trading pairs.');
                console.log('Would add:', symbol);
            }
        }

        // Toggle button handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Coinglass Clone - Funding Rates Monitor');
            console.log('Backend:', BACKEND_URL);
            
            // Initialize toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var group = this.parentElement;
                    group.querySelectorAll('.toggle-btn').forEach(function(b) {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Auto-start data loading
            setTimeout(function() {
                refreshData();
            }, 1000);
            
            // Update settlement times every second
            setInterval(function() {
                if (currentData.length > 0) {
                    currentData.forEach(function(item) {
                        item.settlement = getNextSettlement();
                    });
                    
                    if (!isLoading) {
                        renderTable(filteredData);
                    }
                }
            }, 1000);
            
            console.log('âœ… Coinglass clone initialized');
        });
    </script>
</body>
</html>
