<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Rates Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .add-crypto-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .add-crypto-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-add:hover {
            background: #229954;
        }

        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .section-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }

        td {
            text-align: center;
        }

        .symbol-cell {
            text-align: left !important;
            font-weight: 600;
            color: #2c3e50;
        }

        .rate-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .rate-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .rate-neutral {
            color: #7f8c8d;
        }

        .exchange-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .exchange-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .binance { background: #f0b90b; }
        .bybit { background: #0ecb81; }
        .okx { background: #0d84f2; }
        .bitget { background: #00d4aa; }
        .gate { background: #8b5cf6; }
        .coinex { background: #ff6b35; }

        .arbitrage-row {
            border-left: 4px solid #3498db;
        }

        .arbitrage-row:hover {
            background: #f8f9fa;
        }

        .strategy-cell {
            text-align: left !important;
            max-width: 300px;
        }

        .position-long {
            color: #27ae60;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .position-short {
            color: #e74c3c;
            font-size: 13px;
        }

        .revenue-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .revenue-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-left: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
        }

        @media (max-width: 768px) {
            .add-crypto-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group input, .input-group select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>💰 Funding Rates Monitor</h1>
            <p>Track funding rates across major exchanges and identify arbitrage opportunities</p>
            <div style="margin-top: 15px;">
                <button id="toggle-mode-btn" onclick="toggleDataMode()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                    Switch to Real Data
                </button>
                <input type="text" id="backend-url" placeholder="Backend URL (optional)" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; margin-right: 10px; width: 250px;">
                <span class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="status-text">Demo Mode Active</span>
                </span>
            </div>
        </div>

        <!-- Add Crypto Section -->
        <div class="add-crypto-section">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Add Cryptocurrency</h3>
            <div class="add-crypto-form">
                <div class="input-group">
                    <label for="crypto-symbol">Symbol</label>
                    <input type="text" id="crypto-symbol" placeholder="BTC, ETH, SOL..." maxlength="10">
                </div>
                <div class="input-group">
                    <label for="crypto-pair">Pair Type</label>
                    <select id="crypto-pair">
                        <option value="USDT">USDT Pair</option>
                        <option value="USD">USD Pair</option>
                        <option value="BUSD">BUSD Pair</option>
                    </select>
                </div>
                <button class="btn-add" onclick="addCrypto()">Add to Monitor</button>
            </div>
        </div>

        <!-- Funding Rates Table -->
        <div class="section">
            <div class="section-header">
                📊 Current Funding Rates
                <span style="font-size: 14px; font-weight: normal; float: right;">
                    Last updated: <span id="last-update">--:--</span>
                </span>
            </div>
            <div class="table-container">
                <table id="funding-rates-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Symbol</th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon binance"></div>
                                    Binance
                                </div>
                            </th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon bybit"></div>
                                    Bybit
                                </div>
                            </th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon okx"></div>
                                    OKX
                                </div>
                            </th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon bitget"></div>
                                    Bitget
                                </div>
                            </th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon gate"></div>
                                    Gate.io
                                </div>
                            </th>
                            <th>
                                <div class="exchange-header">
                                    <div class="exchange-icon coinex"></div>
                                    CoinEx
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="funding-rates-body">
                        <tr>
                            <td colspan="7" class="loading">Loading funding rates...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top 5 Arbitrage Opportunities -->
        <div class="section">
            <div class="section-header">
                🎯 Top 5 Arbitrage Opportunities
            </div>
            <div class="table-container">
                <table id="arbitrage-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Rank</th>
                            <th style="text-align: left;">Symbol</th>
                            <th style="text-align: left;">Strategy</th>
                            <th>Divergence</th>
                            <th>Commission</th>
                            <th>Market Fees</th>
                            <th>Slippage</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="arbitrage-body">
                        <tr>
                            <td colspan="8" class="loading">Calculating arbitrage opportunities...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let BACKEND_URL = 'https://funding-rates-backend.onrender.com'; // Votre backend Render
        let fundingRatesData = [];
        let watchedSymbols = ['BTC', 'ETH', 'SOL', 'XRP', 'DOGE']; // Symboles par défaut
        let useRealData = false; // Mode démo par défaut

        // Données de démonstration basées sur vos captures d'écran
        const demoData = [
            { symbol: 'FIL/USDT:USDT', binance: -0.004703, bybit: -0.0232, okx: -0.334535, bitget: -0.0047, gate: -0.0245, coinex: 0.737473 },
            { symbol: 'HNT/USDT:USDT', binance: -0.030722, bybit: -0.0141, okx: null, bitget: null, gate: 0.0051, coinex: 0.304442 },
            { symbol: 'OP/USDT:USDT', binance: -0.057856, bybit: -0.0235, okx: -0.206011, bitget: -0.0589, gate: -0.0162, coinex: -0.148713 },
            { symbol: 'MKR/USDT:USDT', binance: 0.010000, bybit: 0.0100, okx: -0.056437, bitget: 0.0104, gate: 0.0100, coinex: 0.075530 },
            { symbol: 'TON/USDT:USDT', binance: null, bybit: null, okx: -0.023741, bitget: null, gate: 0.0100, coinex: -0.116483 },
            { symbol: 'BTC/USDT:USDT', binance: 0.0048, bybit: 0.0032, okx: 0.0051, bitget: 0.0039, gate: 0.0045, coinex: 0.0041 },
            { symbol: 'ETH/USDT:USDT', binance: 0.0034, bybit: 0.0028, okx: 0.0042, bitget: 0.0031, gate: 0.0037, coinex: 0.0035 },
            { symbol: 'SOL/USDT:USDT', binance: -0.0052, bybit: -0.0039, okx: -0.0048, bitget: -0.0041, gate: -0.0035, coinex: -0.0044 },
            { symbol: 'XRP/USDT:USDT', binance: -0.0076, bybit: -0.0061, okx: -0.0057, bitget: -0.0069, gate: -0.0073, coinex: -0.0065 },
            { symbol: 'DOGE/USDT:USDT', binance: 0.0058, bybit: 0.0042, okx: 0.0061, bitget: 0.0055, gate: 0.0049, coinex: 0.0053 }
        ];

        // Fonctions utilitaires
        function formatRate(rate) {
            if (rate === null || rate === undefined) return 'N/A';
            return (rate * 100).toFixed(4) + '%';
        }

        function getRateClass(rate) {
            if (rate === null || rate === undefined) return 'rate-neutral';
            return rate > 0 ? 'rate-positive' : rate < 0 ? 'rate-negative' : 'rate-neutral';
        }

        function updateStatus(message, isConnected = false, isDemoMode = false) {
            document.getElementById('status-text').textContent = message;
            const dot = document.querySelector('.status-dot');
            if (isDemoMode) {
                dot.style.background = '#f39c12'; // Orange pour le mode démo
            } else {
                dot.style.background = isConnected ? '#27ae60' : '#e74c3c';
            }
        }

        // Fonction pour basculer entre mode démo et réel
        function toggleDataMode() {
            useRealData = !useRealData;
            const btn = document.getElementById('toggle-mode-btn');
            
            if (useRealData) {
                btn.textContent = 'Switch to Demo Mode';
                btn.style.background = '#e67e22';
                
                // Récupérer l'URL personnalisée si fournie
                const customUrl = document.getElementById('backend-url').value.trim();
                if (customUrl) {
                    BACKEND_URL = customUrl;
                }
                
                fetchRealData();
            } else {
                btn.textContent = 'Switch to Real Data';
                btn.style.background = '#3498db';
                loadDemoData();
            }
        }

        // Charger les données de démo
        function loadDemoData() {
            fundingRatesData = [...demoData];
            updateStatus('Demo Mode Active', false, true);
            
            // Ajouter un peu de fluctuation pour simuler des données live
            fundingRatesData.forEach(item => {
                ['binance', 'bybit', 'okx', 'bitget', 'gate', 'coinex'].forEach(exchange => {
                    if (item[exchange] !== null && item[exchange] !== undefined) {
                        item[exchange] += (Math.random() - 0.5) * 0.002; // Fluctuation de ±0.1%
                    }
                });
            });
            
            renderFundingRatesTable();
            calculateAndRenderArbitrage();
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // Fonction pour ajouter une crypto
        function addCrypto() {
            const symbolInput = document.getElementById('crypto-symbol');
            const pairSelect = document.getElementById('crypto-pair');
            
            const symbol = symbolInput.value.trim().toUpperCase();
            const pair = pairSelect.value;
            
            if (!symbol) {
                alert('Please enter a cryptocurrency symbol');
                return;
            }
            
            const fullSymbol = `${symbol}/${pair}:${pair}`;
            
            // Vérifier si déjà ajouté
            if (watchedSymbols.includes(symbol)) {
                alert(`${symbol} is already being monitored`);
                return;
            }
            
            // Ajouter à la liste
            watchedSymbols.push(symbol);
            
            // Simuler des données pour la démo
            const newData = {
                symbol: fullSymbol,
                binance: (Math.random() - 0.5) * 0.02,
                bybit: (Math.random() - 0.5) * 0.02,
                okx: (Math.random() - 0.5) * 0.02,
                bitget: (Math.random() - 0.5) * 0.02,
                gate: (Math.random() - 0.5) * 0.02,
                coinex: (Math.random() - 0.5) * 0.02
            };
            
            fundingRatesData.push(newData);
            
            // Effacer le formulaire
            symbolInput.value = '';
            
            // Mettre à jour l'affichage
            renderFundingRatesTable();
            calculateAndRenderArbitrage();
            
            console.log(`Added ${symbol} to monitoring`);
        }

        // Rendu de la table des funding rates
        function renderFundingRatesTable() {
            const tbody = document.getElementById('funding-rates-body');
            
            if (fundingRatesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No data available</td></tr>';
                return;
            }
            
            const rows = fundingRatesData.map(item => {
                const cleanSymbol = item.symbol.split('/')[0]; // Extraire juste BTC de BTC/USDT:USDT
                
                return `
                    <tr>
                        <td class="symbol-cell">${cleanSymbol}</td>
                        <td class="${getRateClass(item.binance)}">${formatRate(item.binance)}</td>
                        <td class="${getRateClass(item.bybit)}">${formatRate(item.bybit)}</td>
                        <td class="${getRateClass(item.okx)}">${formatRate(item.okx)}</td>
                        <td class="${getRateClass(item.bitget)}">${formatRate(item.bitget)}</td>
                        <td class="${getRateClass(item.gate)}">${formatRate(item.gate)}</td>
                        <td class="${getRateClass(item.coinex)}">${formatRate(item.coinex)}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
            updateLastUpdateTime();
        }

        // Calcul et rendu des opportunités d'arbitrage
        function calculateAndRenderArbitrage() {
            const exchanges = ['binance', 'bybit', 'okx', 'bitget', 'gate', 'coinex'];
            const opportunities = [];
            
            fundingRatesData.forEach(item => {
                const rates = [];
                
                exchanges.forEach(ex => {
                    if (item[ex] !== null && item[ex] !== undefined) {
                        rates.push({ exchange: ex, rate: item[ex] });
                    }
                });
                
                if (rates.length >= 2) {
                    rates.sort((a, b) => a.rate - b.rate);
                    
                    const longEx = rates[0];
                    const shortEx = rates[rates.length - 1];
                    const divergence = shortEx.rate - longEx.rate;
                    const commission = 0.002; // 0.2% commission basée sur votre code
                    const marketFees = 0.001; // 0.1% market fees
                    const slippage = 0.0005; // 0.05% slippage estimé
                    const revenue = (divergence * 100) - commission - marketFees - slippage;
                    
                    if (Math.abs(divergence) > 0.001) { // Seuil minimum
                        opportunities.push({
                            symbol: item.symbol.split('/')[0],
                            longExchange: longEx.exchange,
                            shortExchange: shortEx.exchange,
                            longRate: longEx.rate,
                            shortRate: shortEx.rate,
                            divergence: divergence * 100,
                            commission: commission,
                            marketFees: marketFees,
                            slippage: slippage,
                            revenue: revenue
                        });
                    }
                }
            });
            
            // Trier par revenue décroissant
            opportunities.sort((a, b) => Math.abs(b.revenue) - Math.abs(a.revenue));
            
            // Prendre le top 5
            const top5 = opportunities.slice(0, 5);
            
            renderArbitrageTable(top5);
        }

        function renderArbitrageTable(opportunities) {
            const tbody = document.getElementById('arbitrage-body');
            
            if (opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No arbitrage opportunities found</td></tr>';
                return;
            }
            
            const exchangeNames = {
                binance: 'Binance',
                bybit: 'Bybit',
                okx: 'OKX',
                bitget: 'Bitget',
                gate: 'Gate.io',
                coinex: 'CoinEx'
            };
            
            const rows = opportunities.map((opp, index) => {
                const revenueClass = opp.revenue > 0 ? 'revenue-positive' : 'revenue-negative';
                
                return `
                    <tr class="arbitrage-row">
                        <td style="text-align: left; font-weight: 600;">#${index + 1}</td>
                        <td class="symbol-cell">${opp.symbol}</td>
                        <td class="strategy-cell">
                            <div class="position-long">LONG ${exchangeNames[opp.longExchange]} (${formatRate(opp.longRate)})</div>
                            <div class="position-short">SHORT ${exchangeNames[opp.shortExchange]} (${formatRate(opp.shortRate)})</div>
                        </td>
                        <td class="rate-positive">${opp.divergence.toFixed(4)}%</td>
                        <td>${(opp.commission * 100).toFixed(3)}%</td>
                        <td>${(opp.marketFees * 100).toFixed(3)}%</td>
                        <td>${(opp.slippage * 100).toFixed(3)}%</td>
                        <td class="${revenueClass}">${opp.revenue.toFixed(4)}%</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        // Fonction pour récupérer les données réelles
        async function fetchRealData() {
            try {
                updateStatus('Connecting to backend...', false);
                
                console.log(`Attempting to fetch from: ${BACKEND_URL}/api/funding-rates`);
                
                const response = await fetch(`${BACKEND_URL}/api/funding-rates`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // Ajouter un timeout
                    signal: AbortSignal.timeout(10000) // 10 secondes
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('✅ Real data received:', data);
                
                // Traiter les données du backend
                fundingRatesData = processBackendData(data);
                updateStatus('🟢 Live Data Connected', true);
                
                renderFundingRatesTable();
                calculateAndRenderArbitrage();
                
            } catch (error) {
                console.error('❌ Failed to fetch real data:', error);
                
                let errorMessage = 'Connection Failed';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request Timeout';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Backend Offline';
                }
                
                updateStatus(`🔴 ${errorMessage} - Using Demo`, false);
                
                // Revenir au mode démo automatiquement
                useRealData = false;
                const btn = document.getElementById('toggle-mode-btn');
                btn.textContent = 'Switch to Real Data';
                btn.style.background = '#3498db';
                
                loadDemoData();
            }
        }

        function processBackendData(data) {
            // Grouper les données par symbole
            const grouped = {};
            const dataArray = Array.isArray(data) ? data : (data.data || []);
            
            dataArray.forEach(item => {
                const symbol = item.symbol;
                const exchange = item.exchange.toLowerCase();
                const rate = parseFloat(item.fundingRate);
                
                if (!grouped[symbol]) {
                    grouped[symbol] = {
                        symbol: symbol,
                        binance: null,
                        bybit: null,
                        okx: null,
                        bitget: null,
                        gate: null,
                        coinex: null
                    };
                }
                
                grouped[symbol][exchange] = rate;
            });
            
            return Object.values(grouped);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('💰 Funding Rates Monitor loaded');
            
            // Démarrer en mode démo
            loadDemoData();
            
            // Actualiser automatiquement selon le mode
            setInterval(() => {
                if (useRealData) {
                    fetchRealData();
                } else {
                    // Rafraîchir les données démo avec de légères fluctuations
                    loadDemoData();
                }
            }, 30000); // Toutes les 30 secondes
            
            // Gérer la touche Entrée dans le champ de saisie
            document.getElementById('crypto-symbol').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCrypto();
                }
            });
            
            // Gérer la touche Entrée dans le champ URL backend
            document.getElementById('backend-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && useRealData) {
                    const customUrl = this.value.trim();
                    if (customUrl) {
                        BACKEND_URL = customUrl;
                        fetchRealData();
                    }
                }
            });
            
            console.log('✅ Interface ready - Demo mode active');
            console.log('🔧 Click "Switch to Real Data" when your backend is ready');
        });
    </script>
</body>
</html>
