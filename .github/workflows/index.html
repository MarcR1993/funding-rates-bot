// Basculer exchange
        function toggleExchange(key) {
            config.exchanges[key].active = !config.exchanges[key<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding Rates Bot - Arbitrage Crypto Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .api-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .api-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .exchange-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .exchange-binance { background: #f0b90b; color: #000; }
        .exchange-kucoin { background: #24ae8f; color: #fff; }
        .exchange-bybit { background: #f7931a; color: #fff; }
        .exchange-okx { background: #1677ff; color: #fff; }

        .funding-rate {
            font-weight: bold;
        }

        .funding-rate.positive { color: #4CAF50; }
        .funding-rate.negative { color: #f44336; }

        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .crypto-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .crypto-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .crypto-item.selected {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .crypto-symbol {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .crypto-name {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .exchange-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .exchange-card.connected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .exchange-card.disabled {
            opacity: 0.5;
        }

        .exchange-toggle {
            margin-top: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .arbitrage-section {
            margin-bottom: 30px;
        }

        .funding-schedule {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .schedule-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .schedule-time {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .schedule-exchanges {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .opportunity-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .opportunity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .opportunity-crypto {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .opportunity-apr {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .opportunity-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .detail-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: bold;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            color: white;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: white;
            opacity: 0.7;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .settings-grid {
            display: grid;
            gap: 20px;
        }

        .setting-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .setting-group h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 8px 12px;
            color: white;
            width: 100px;
        }

        .setting-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .tab-nav {
                gap: 5px;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .opportunity-details {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FUNDING RATES BOT</h1>
            <p>Configuration facile - Interface No-Code + APIs Live</p>
            <div id="api-status" class="api-status">
                <span style="color: #ffd93d;">‚ö°</span> Connexion aux APIs en cours...
            </div>
        </div>

        <nav class="tab-nav">
            <div class="tab-btn active" data-tab="dashboard">DASHBOARD</div>
            <div class="tab-btn" data-tab="cryptos">CRYPTOS</div>
            <div class="tab-btn" data-tab="exchanges">EXCHANGES</div>
            <div class="tab-btn" data-tab="arbitrage">ARBITRAGE</div>
            <div class="tab-btn" data-tab="settings">PARAMETRES</div>
        </nav>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>üìä Vue d'ensemble</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stats-cryptos">7</div>
                            <div class="stat-label">Cryptos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stats-exchanges">4</div>
                            <div class="stat-label">Exchanges</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stats-pairs">28</div>
                            <div class="stat-label">Pairs</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üî• Top Opportunities</h3>
                    <div id="top-opportunities">
                        <div style="text-align: center; opacity: 0.7; padding: 20px;">
                            Chargement des opportunit√©s...
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚è∞ Prochains Fundings</h3>
                    <div id="next-fundings">
                        <div style="text-align: center; opacity: 0.7; padding: 20px;">
                            Calcul des horaires...
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Funding Rates Live</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Crypto</th>
                                <th>Exchange</th>
                                <th>Funding Rate</th>
                                <th>APR Annuel</th>
                                <th>Prochain Funding</th>
                            </tr>
                        </thead>
                        <tbody id="live-data-table">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px; opacity: 0.7;">
                                    üîÑ Chargement des donn√©es live...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CRYPTOS TAB -->
        <div id="cryptos" class="tab-content">
            <div class="card">
                <h3>ü™ô Gestion des Cryptomonnaies</h3>
                <p style="margin-bottom: 20px; opacity: 0.8;">S√©lectionne les cryptos √† surveiller pour l'arbitrage</p>
                <div class="crypto-grid" id="crypto-grid">
                    <!-- Cryptos seront ajout√©es dynamiquement -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveCryptoConfig()">Sauvegarder Configuration</button>
                </div>
            </div>
        </div>

        <!-- EXCHANGES TAB -->
        <div id="exchanges" class="tab-content">
            <div class="card">
                <h3>üè¢ Gestion des Exchanges</h3>
                <p style="margin-bottom: 20px; opacity: 0.8;">Active/d√©sactive les exchanges que tu veux surveiller</p>
                <div class="exchange-grid" id="exchange-grid">
                    <!-- Exchanges seront ajout√©s dynamiquement -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveExchangeConfig()">Sauvegarder Configuration</button>
                </div>
            </div>
        </div>

        <!-- ARBITRAGE TAB -->
        <div id="arbitrage" class="tab-content">
            <div class="arbitrage-section">
                <div class="card">
                    <h3>‚è∞ Horaires de Funding</h3>
                    <div class="funding-schedule">
                        <div class="schedule-item">
                            <div class="schedule-time">00:00 UTC</div>
                            <div class="schedule-exchanges">Binance ‚Ä¢ KuCoin ‚Ä¢ Bybit</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-time">01:00 UTC</div>
                            <div class="schedule-exchanges">OKX</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-time">08:00 UTC</div>
                            <div class="schedule-exchanges">Binance ‚Ä¢ KuCoin ‚Ä¢ Bybit</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-time">09:00 UTC</div>
                            <div class="schedule-exchanges">OKX</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-time">16:00 UTC</div>
                            <div class="schedule-exchanges">Binance ‚Ä¢ KuCoin ‚Ä¢ Bybit</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-time">17:00 UTC</div>
                            <div class="schedule-exchanges">OKX</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üî• TOP 5 Opportunit√©s d'Arbitrage</h3>
                <div id="arbitrage-opportunities">
                    <div style="text-align: center; opacity: 0.7; padding: 40px;">
                        üìä Calcul des opportunit√©s en cours...<br>
                        <small>Analyse des spreads entre exchanges</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="settings-grid">
                <div class="setting-group">
                    <h4>‚öôÔ∏è Param√®tres G√©n√©raux</h4>
                    <div class="setting-item">
                        <span>Fr√©quence de collecte (secondes)</span>
                        <input type="number" class="setting-input" value="30" id="refresh-interval">
                    </div>
                    <div class="setting-item">
                        <span>Seuil d'alerte APR (%)</span>
                        <input type="number" class="setting-input" value="50" id="alert-threshold">
                    </div>
                    <div class="setting-item">
                        <span>Notifications actives</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notifications-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>üìä Affichage</h4>
                    <div class="setting-item">
                        <span>Nombre max d'opportunit√©s</span>
                        <input type="number" class="setting-input" value="5" id="max-opportunities">
                    </div>
                    <div class="setting-item">
                        <span>Pr√©cision des taux (%)</span>
                        <input type="number" class="setting-input" value="4" id="rate-precision">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder Param√®tres</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Configuration globale
        const config = {
            cryptos: {
                available: [
                    { symbol: 'BTC', name: 'Bitcoin' },
                    { symbol: 'ETH', name: 'Ethereum' },
                    { symbol: 'SOL', name: 'Solana' },
                    { symbol: 'ADA', name: 'Cardano' },
                    { symbol: 'DOT', name: 'Polkadot' },
                    { symbol: 'MATIC', name: 'Polygon' },
                    { symbol: 'LINK', name: 'Chainlink' },
                    { symbol: 'AVAX', name: 'Avalanche' },
                    { symbol: 'ATOM', name: 'Cosmos' },
                    { symbol: 'NEAR', name: 'Near Protocol' }
                ],
                selected: ['BTC', 'ETH', 'SOL', 'ADA', 'DOT', 'MATIC', 'LINK']
            },
            exchanges: {
                binance: { name: 'Binance', active: true, type: 'Futures USDT' },
                kucoin: { name: 'KuCoin', active: false, type: 'Futures USDT' },
                bybit: { name: 'Bybit', active: false, type: 'USDT Perpetual' },
                okx: { name: 'OKX', active: false, type: 'Perpetual Swaps' }
            },
            settings: {
                refreshInterval: 30,
                alertThreshold: 50,
                maxOpportunities: 5,
                ratePrecision: 4,
                notificationsEnabled: true
            }
        };

        // Donn√©es live
        let liveData = [];
        let opportunities = [];

        // Configuration des fees par exchange (maker fees en %)
        const exchangeFees = {
            binance: { maker: 0.02, taker: 0.04, slippage: 0.05 },
            kucoin: { maker: 0.02, taker: 0.06, slippage: 0.08 },
            bybit: { maker: 0.01, taker: 0.06, slippage: 0.07 },
            okx: { maker: 0.02, taker: 0.05, slippage: 0.06 }
        };

        // API avec proxy universel
        async function fetchWithProxy(url) {
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://cors-anywhere.herokuapp.com/',
                '' // Direct (pour GitHub Pages)
            ];
            
            for (let i = 0; i < proxies.length; i++) {
                try {
                    const proxyUrl = proxies[i];
                    const fullUrl = proxyUrl ? proxyUrl + encodeURIComponent(url) : url;
                    
                    const response = await fetch(fullUrl);
                    const data = await response.json();
                    return data;
                    
                } catch (error) {
                    if (i === proxies.length - 1) {
                        throw error;
                    }
                }
            }
        }

        // API Binance Futures
        async function fetchBinanceFundingRates() {
            try {
                const data = await fetchWithProxy('https://fapi.binance.com/fapi/v1/premiumIndex');
                console.log('‚úÖ Binance connect√©:', data.length, 'pairs');
                
                return data.filter(item => 
                    item.symbol.endsWith('USDT') && 
                    config.cryptos.selected.some(crypto => item.symbol.startsWith(crypto))
                ).map(item => ({
                    exchange: 'Binance',
                    symbol: item.symbol.replace('USDT', ''),
                    fundingRate: parseFloat(item.lastFundingRate),
                    nextFunding: item.nextFundingTime,
                    markPrice: parseFloat(item.markPrice)
                }));
            } catch (error) {
                console.error('‚ùå Binance API error:', error);
                return [];
            }
        }

        // API KuCoin Futures
        async function fetchKucoinFundingRates() {
            try {
                const data = await fetchWithProxy('https://api-futures.kucoin.com/api/v1/contracts/active');
                console.log('‚úÖ KuCoin connect√©:', data.data.length, 'pairs');
                
                const fundingData = await fetchWithProxy('https://api-futures.kucoin.com/api/v1/funding-rate');
                
                return data.data.filter(item => 
                    item.quoteCurrency === 'USDT' && 
                    config.cryptos.selected.some(crypto => item.baseCurrency === crypto)
                ).map(item => {
                    const fundingInfo = fundingData.data.find(f => f.symbol === item.symbol);
                    return {
                        exchange: 'KuCoin',
                        symbol: item.baseCurrency,
                        fundingRate: fundingInfo ? parseFloat(fundingInfo.value) : 0,
                        nextFunding: Date.now() + (8 * 60 * 60 * 1000), // Approximation
                        markPrice: parseFloat(item.markPrice || 0)
                    };
                });
            } catch (error) {
                console.error('‚ùå KuCoin API error:', error);
                return [];
            }
        }

        // API Bybit Futures
        async function fetchBybitFundingRates() {
            try {
                const data = await fetchWithProxy('https://api.bybit.com/v5/market/instruments-info?category=linear');
                console.log('‚úÖ Bybit connect√©:', data.result.list.length, 'pairs');
                
                const fundingData = await fetchWithProxy('https://api.bybit.com/v5/market/funding/history?category=linear&limit=200');
                
                return data.result.list.filter(item => 
                    item.quoteCoin === 'USDT' && 
                    config.cryptos.selected.some(crypto => item.baseCoin === crypto)
                ).map(item => {
                    const fundingInfo = fundingData.result.list.find(f => f.symbol === item.symbol);
                    return {
                        exchange: 'Bybit',
                        symbol: item.baseCoin,
                        fundingRate: fundingInfo ? parseFloat(fundingInfo.fundingRate) : 0,
                        nextFunding: fundingInfo ? fundingInfo.fundingRateTimestamp : Date.now(),
                        markPrice: parseFloat(item.markPrice || 0)
                    };
                });
            } catch (error) {
                console.error('‚ùå Bybit API error:', error);
                return [];
            }
        }

        // API OKX Futures
        async function fetchOKXFundingRates() {
            try {
                const data = await fetchWithProxy('https://www.okx.com/api/v5/public/instruments?instType=SWAP');
                console.log('‚úÖ OKX connect√©:', data.data.length, 'pairs');
                
                const fundingData = await fetchWithProxy('https://www.okx.com/api/v5/public/funding-rate?instType=SWAP');
                
                return data.data.filter(item => 
                    item.instId.endsWith('-USDT-SWAP') && 
                    config.cryptos.selected.some(crypto => item.instId.startsWith(crypto))
                ).map(item => {
                    const symbol = item.instId.split('-')[0];
                    const fundingInfo = fundingData.data.find(f => f.instId === item.instId);
                    return {
                        exchange: 'OKX',
                        symbol: symbol,
                        fundingRate: fundingInfo ? parseFloat(fundingInfo.fundingRate) : 0,
                        nextFunding: fundingInfo ? fundingInfo.nextFundingTime : Date.now(),
                        markPrice: parseFloat(item.markPx || 0)
                    };
                });
            } catch (error) {
                console.error('‚ùå OKX API error:', error);
                return [];
            }
        }

        // Charger donn√©es de tous les exchanges actifs
        async function loadLiveData() {
            try {
                liveData = [];
                const promises = [];
                
                // Charger donn√©es selon exchanges actifs
                if (config.exchanges.binance.active) {
                    promises.push(fetchBinanceFundingRates());
                }
                if (config.exchanges.kucoin.active) {
                    promises.push(fetchKucoinFundingRates());
                }
                if (config.exchanges.bybit.active) {
                    promises.push(fetchBybitFundingRates());
                }
                if (config.exchanges.okx.active) {
                    promises.push(fetchOKXFundingRates());
                }
                
                const results = await Promise.allSettled(promises);
                
                // Combiner toutes les donn√©es
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        liveData = liveData.concat(result.value);
                    }
                });
                
                const connectedExchanges = Object.values(config.exchanges).filter(e => e.active).length;
                const apiStatus = document.getElementById('api-status');
                
                if (liveData.length > 0) {
                    apiStatus.className = 'api-status success';
                    apiStatus.innerHTML = `<span style="color: #4CAF50;">‚úì</span> ${connectedExchanges} Exchanges LIVE - ${liveData.length} pairs connect√©es`;
                } else {
                    apiStatus.className = 'api-status error';
                    apiStatus.innerHTML = '<span style="color: #f44336;">‚úó</span> Erreur connexion APIs';
                }
                
                console.log('üìä Donn√©es charg√©es:', liveData.length, 'pairs de', connectedExchanges, 'exchanges');
                updateStats();
                
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                const apiStatus = document.getElementById('api-status');
                apiStatus.className = 'api-status error';
                apiStatus.innerHTML = '<span style="color: #f44336;">‚úó</span> Erreur APIs multiples';
                
                showModal(`‚ùå ERREUR CONNEXION APIS<br><br><strong>Probl√®me:</strong> Restrictions CORS<br><br><strong>‚úÖ SOLUTIONS:</strong><br><br>1Ô∏è‚É£ <strong>GitHub Pages</strong> (Recommand√©)<br>2Ô∏è‚É£ <strong>Serveur Local</strong><br>3Ô∏è‚É£ <strong>H√©bergeur externe</strong><br><br><small>üí° Les APIs fonctionnent parfaitement sur GitHub Pages</small>`);
            }
        }

        // Calculer opportunit√©s d'arbitrage avec fees et slippage
        function calculateArbitrageOpportunities() {
            if (liveData.length === 0) return;

            const oppsBySymbol = {};
            
            // Grouper par symbole
            liveData.forEach(item => {
                if (!oppsBySymbol[item.symbol]) {
                    oppsBySymbol[item.symbol] = [];
                }
                oppsBySymbol[item.symbol].push(item);
            });

            const newOpportunities = [];
            
            // Calculer arbitrage pour chaque crypto
            Object.keys(oppsBySymbol).forEach(symbol => {
                const rates = oppsBySymbol[symbol];
                if (rates.length < 2) return;

                // Trouver la meilleure paire d'exchanges
                for (let i = 0; i < rates.length; i++) {
                    for (let j = i + 1; j < rates.length; j++) {
                        const rate1 = rates[i];
                        const rate2 = rates[j];
                        
                        // D√©terminer qui est long/short
                        const isRate1Lower = rate1.fundingRate < rate2.fundingRate;
                        const longExchange = isRate1Lower ? rate1 : rate2;
                        const shortExchange = isRate1Lower ? rate2 : rate1;
                        
                        const netFundingGross = Math.abs(shortExchange.fundingRate - longExchange.fundingRate);
                        
                        // Calculer les co√ªts
                        const longFees = exchangeFees[longExchange.exchange.toLowerCase()];
                        const shortFees = exchangeFees[shortExchange.exchange.toLowerCase()];
                        
                        const totalMakerFees = (longFees.maker + shortFees.maker) / 100; // Ouverture
                        const totalSlippage = (longFees.slippage + shortFees.slippage) / 100;
                        const exitFees = totalMakerFees; // Fermeture
                        
                        // Net funding apr√®s tous les co√ªts
                        const netFunding = netFundingGross - totalMakerFees - totalSlippage;
                        const netFundingPerCycle = netFunding; // Par funding (8h)
                        
                        // APR = (Net Funding par 8h √ó 3 fundings/jour √ó 365 jours) √ó 100
                        const aprGross = netFundingGross * 365 * 3 * 100;
                        const aprNet = netFundingPerCycle * 365 * 3 * 100;
                        
                        // V√©rifier si profitable apr√®s co√ªts
                        if (aprNet > config.settings.alertThreshold && netFunding > 0) {
                            const spread = (netFundingGross / ((longExchange.fundingRate + shortExchange.fundingRate) / 2)) * 100;
                            
                            newOpportunities.push({
                                symbol,
                                aprGross: aprGross,
                                aprNet: aprNet,
                                netFundingGross: netFundingGross,
                                netFundingNet: netFunding,
                                spread: Math.abs(spread),
                                longExchange: longExchange.exchange,
                                shortExchange: shortExchange.exchange,
                                longRate: longExchange.fundingRate,
                                shortRate: shortExchange.fundingRate,
                                fees: {
                                    makerFees: totalMakerFees * 100,
                                    slippage: totalSlippage * 100,
                                    exitFees: exitFees * 100,
                                    totalCosts: (totalMakerFees + totalSlippage + exitFees) * 100
                                },
                                nextFunding: longExchange.nextFunding,
                                profitability: aprNet / aprGross // Ratio net/gross
                            });
                        }
                    }
                }
            });

            // Trier par APR net d√©croissant
            opportunities = newOpportunities.sort((a, b) => b.aprNet - a.aprNet).slice(0, config.settings.maxOpportunities);
            
            updateArbitrageDisplay();
            updateTopOpportunities();
        }

        // Mettre √† jour l'affichage des statistiques
        function updateStats() {
            document.getElementById('stats-cryptos').textContent = config.cryptos.selected.length;
            document.getElementById('stats-exchanges').textContent = Object.values(config.exchanges).filter(e => e.active).length;
            document.getElementById('stats-pairs').textContent = liveData.length;
            updateLiveDataTable();
            calculateArbitrageOpportunities();
        }

        // Mettre √† jour le tableau des donn√©es live
        function updateLiveDataTable() {
            const tbody = document.getElementById('live-data-table');
            
            if (liveData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; opacity: 0.7;">
                            ‚ö†Ô∏è Aucune donn√©e disponible
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = liveData.map(item => {
                const apr = item.fundingRate * 365 * 3 * 100;
                const nextFunding = new Date(parseInt(item.nextFunding)).toLocaleString('fr-FR');
                const rateClass = item.fundingRate >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td><strong>${item.symbol}</strong></td>
                        <td><span class="exchange-badge exchange-${item.exchange.toLowerCase()}">${item.exchange}</span></td>
                        <td><span class="funding-rate ${rateClass}">${(item.fundingRate * 100).toFixed(config.settings.ratePrecision)}%</span></td>
                        <td><span class="funding-rate ${rateClass}">${apr.toFixed(1)}%</span></td>
                        <td>${nextFunding}</td>
                    </tr>
                `;
            }).join('');
        }

        // Mettre √† jour les top opportunit√©s
        function updateTopOpportunities() {
            const container = document.getElementById('top-opportunities');
            
            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 20px;">
                        üìä Aucune opportunit√© profitable apr√®s fees
                    </div>
                `;
                return;
            }

            container.innerHTML = opportunities.slice(0, 3).map(opp => `
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${opp.symbol}</strong>
                        <span style="color: #4CAF50; font-weight: bold;">${opp.aprNet.toFixed(1)}% APR Net</span>
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">
                        Long ${opp.longExchange} ‚Ä¢ Short ${opp.shortExchange}
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 3px;">
                        Co√ªts: ${opp.fees.totalCosts.toFixed(2)}% ‚Ä¢ Profit: ${(opp.profitability * 100).toFixed(1)}%
                    </div>
                </div>
            `).join('');
        }

        // Mettre √† jour l'affichage des prochains fundings
        function updateNextFundings() {
            const container = document.getElementById('next-fundings');
            const now = new Date();
            const fundings = [];

            // Horaires de funding (UTC)
            const fundingHours = [0, 8, 16]; // Binance, KuCoin, Bybit
            const okxHours = [1, 9, 17]; // OKX

            fundingHours.forEach(hour => {
                const nextFunding = new Date(now);
                nextFunding.setUTCHours(hour, 0, 0, 0);
                if (nextFunding <= now) {
                    nextFunding.setUTCDate(nextFunding.getUTCDate() + 1);
                }
                fundings.push({
                    time: nextFunding,
                    exchanges: 'Binance, KuCoin, Bybit'
                });
            });

            okxHours.forEach(hour => {
                const nextFunding = new Date(now);
                nextFunding.setUTCHours(hour, 0, 0, 0);
                if (nextFunding <= now) {
                    nextFunding.setUTCDate(nextFunding.getUTCDate() + 1);
                }
                fundings.push({
                    time: nextFunding,
                    exchanges: 'OKX'
                });
            });

            fundings.sort((a, b) => a.time - b.time);

            container.innerHTML = fundings.slice(0, 3).map(funding => {
                const timeUntil = Math.floor((funding.time - now) / (1000 * 60 * 60));
                return `
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 5px;">
                        <div style="font-weight: bold;">${funding.time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${funding.exchanges}</div>
                        <div style="font-size: 0.8rem; color: #4CAF50;">Dans ${timeUntil}h</div>
                    </div>
                `;
            }).join('');
        }

        // Mettre √† jour l'affichage de l'arbitrage
        function updateArbitrageDisplay() {
            const container = document.getElementById('arbitrage-opportunities');
            
            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 40px;">
                        üìä Aucune opportunit√© profitable apr√®s fees & slippage<br>
                        <small>Les spreads ne couvrent pas les co√ªts de trading actuellement</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = opportunities.map((opp, index) => `
                <div class="opportunity-card">
                    <div class="opportunity-header">
                        <div class="opportunity-crypto">#${index + 1} ${opp.symbol}</div>
                        <div class="opportunity-apr">${opp.aprNet.toFixed(1)}% APR Net</div>
                    </div>
                    
                    <!-- R√©sum√© de la strat√©gie -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 8px;">üí° Strat√©gie recommand√©e:</div>
                        <div style="font-size: 0.9rem;">
                            üìà <strong>Long ${opp.symbol}</strong> sur ${opp.longExchange} (${(opp.longRate * 100).toFixed(4)}%)<br>
                            üìâ <strong>Short ${opp.symbol}</strong> sur ${opp.shortExchange} (${(opp.shortRate * 100).toFixed(4)}%)
                        </div>
                    </div>
                    
                    <div class="opportunity-details">
                        <div class="detail-item">
                            <div class="detail-label">APR Brut</div>
                            <div class="detail-value" style="color: #ffd93d;">${opp.aprGross.toFixed(1)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">APR Net</div>
                            <div class="detail-value" style="color: #4CAF50;">${opp.aprNet.toFixed(1)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Funding Net/8h</div>
                            <div class="detail-value">+${(opp.netFundingNet * 100).toFixed(4)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Spread</div>
                            <div class="detail-value">${opp.spread.toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Co√ªts Totaux</div>
                            <div class="detail-value" style="color: #f44336;">-${opp.fees.totalCosts.toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Profitabilit√©</div>
                            <div class="detail-value">${(opp.profitability * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <!-- D√©tail des co√ªts -->
                    <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; margin-top: 15px;">
                        <div style="font-size: 0.85rem; opacity: 0.8;">
                            <strong>üí∞ D√©tail des co√ªts:</strong><br>
                            ‚Ä¢ Maker fees: ${opp.fees.makerFees.toFixed(2)}% (ouverture)<br>
                            ‚Ä¢ Slippage: ${opp.fees.slippage.toFixed(2)}% (ex√©cution)<br>
                            ‚Ä¢ Exit fees: ${opp.fees.exitFees.toFixed(2)}% (fermeture)<br>
                            ‚Ä¢ <strong>Total: ${opp.fees.totalCosts.toFixed(2)}%</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Initialiser les cryptos
        function initCryptos() {
            const grid = document.getElementById('crypto-grid');
            grid.innerHTML = config.cryptos.available.map(crypto => `
                <div class="crypto-item ${config.cryptos.selected.includes(crypto.symbol) ? 'selected' : ''}" 
                     data-symbol="${crypto.symbol}" onclick="toggleCrypto('${crypto.symbol}')">
                    <div class="crypto-symbol">${crypto.symbol}</div>
                    <div class="crypto-name">${crypto.name}</div>
                </div>
            `).join('');
        }

        // Basculer s√©lection crypto
        function toggleCrypto(symbol) {
            const index = config.cryptos.selected.indexOf(symbol);
            if (index > -1) {
                config.cryptos.selected.splice(index, 1);
            } else {
                config.cryptos.selected.push(symbol);
            }
            initCryptos();
        }

        // Sauvegarder config crypto
        function saveCryptoConfig() {
            showModal('‚úÖ Configuration des cryptos sauvegard√©e !<br><br>Cryptos s√©lectionn√©es: ' + config.cryptos.selected.join(', '));
            loadLiveData(); // Recharger les donn√©es
        }

        // Initialiser les exchanges
        function initExchanges() {
            const grid = document.getElementById('exchange-grid');
            grid.innerHTML = Object.entries(config.exchanges).map(([key, exchange]) => `
                <div class="exchange-card ${exchange.active ? 'connected' : 'disabled'}">
                    <h4>${exchange.name}</h4>
                    <p>${exchange.type}</p>
                    <div style="margin: 10px 0;">
                        ${exchange.active ? '‚úÖ Connect√© & Actif' : '‚ö™ Disponible'}
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin: 5px 0;">
                        Maker: ${exchangeFees[key].maker}% ‚Ä¢ Slippage: ${exchangeFees[key].slippage}%
                    </div>
                    <div class="exchange-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" ${exchange.active ? 'checked' : ''} 
                                   onchange="toggleExchange('${key}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        // Basculer exchange
        function toggleExchange(key) {
            config.exchanges[key].active = !config.exchanges[key].active;
            initExchanges();
            
            if (config.exchanges[key].active) {
                showModal(`‚úÖ ${config.exchanges[key].name} activ√© !<br><br>Rechargement des donn√©es en cours...`);
                loadLiveData();
            } else {
                showModal(`‚ö†Ô∏è ${config.exchanges[key].name} d√©sactiv√© !<br><br>Les donn√©es de cet exchange ne seront plus collect√©es.`);
                // Retirer les donn√©es de cet exchange
                liveData = liveData.filter(item => item.exchange !== config.exchanges[key].name);
                updateStats();
            }
        }

        // Sauvegarder config exchange
        function saveExchangeConfig() {
            showModal('‚úÖ Configuration des exchanges sauvegard√©e !');
        }

        // Sauvegarder param√®tres
        function saveSettings() {
            config.settings.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            config.settings.alertThreshold = parseInt(document.getElementById('alert-threshold').value);
            config.settings.maxOpportunities = parseInt(document.getElementById('max-opportunities').value);
            config.settings.ratePrecision = parseInt(document.getElementById('rate-precision').value);
            config.settings.notificationsEnabled = document.getElementById('notifications-enabled').checked;
            
            showModal('‚úÖ Param√®tres sauvegard√©s !<br><br>Nouveaux param√®tres appliqu√©s.');
        }

        // Gestion des onglets
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    // Retirer active de tous
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Ajouter active au s√©lectionn√©
                    btn.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // Modal
        function showModal(content) {
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Fermer modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialisation
        function init() {
            initTabs();
            initCryptos();
            initExchanges();
            loadLiveData();
            updateNextFundings();
            
            // Auto-refresh
            setInterval(() => {
                loadLiveData();
                updateNextFundings();
            }, config.settings.refreshInterval * 1000);
            
            setTimeout(() => {
                showModal('üöÄ FUNDING RATES BOT MULTI-EXCHANGE!<br><br>‚úÖ <strong>4 Exchanges connect√©s:</strong><br>‚Ä¢ Binance Futures API<br>‚Ä¢ KuCoin Futures API<br>‚Ä¢ Bybit Linear API<br>‚Ä¢ OKX Swap API<br><br>‚úÖ <strong>Arbitrage avec co√ªts r√©els:</strong><br>‚Ä¢ Maker fees par exchange<br>‚Ä¢ Slippage calcul√©<br>‚Ä¢ APR Net apr√®s tous les co√ªts<br><br>üî• <strong>Pr√™t pour le trading professionnel!</strong><br><br><small>üí° Active/d√©sactive les exchanges dans l\'onglet EXCHANGES</small>');
            }, 2000);
        }

        // D√©marrer l'application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
